pipeline {
    agent any

    environment {
        TZ = "Asia/Seoul"
        SRV_DIR = "/srv"
        BE_DIR = "/workspace/backend/be"
    }

    options {
        timestamps()
    }

    stages {

        stage('Detect changes in be/') {
            steps {
                script {
                    def changed = true

                    if (currentBuild.rawBuild.getPreviousBuild() != null) {
                        def diffOutput = sh(
                            script: """
                                git fetch origin develop
                                git diff --name-only HEAD~1 HEAD | grep '^be/' || true
                            """,
                            returnStdout: true
                        ).trim()

                        if (diffOutput == "") {
                            changed = false
                        }
                    }

                    if (!changed) {
                        echo "âœ… be/ ë””ë ‰í† ë¦¬ ë‚´ ë³€ê²½ ì—†ìŒ. ë¹Œë“œ/ë°°í¬ ì‘ì—… ìŠ¤í‚µ."
                        currentBuild.result = 'SUCCESS'
                        error("NO_CHANGE_IN_BE")
                    } else {
                        echo "ğŸ”„ be/ ë””ë ‰í† ë¦¬ ë³€ê²½ ê°ì§€. ë¹Œë“œ ê³„ì† ì§„í–‰."
                    }
                }
            }
        }

        stage('Gradle build (bootJar)') {
            steps {
                sh """
                cd ${BE_DIR}
                chmod +x gradlew
                ./gradlew clean bootJar --no-daemon
                """
            }
        }

        stage('Docker build via compose') {
            steps {
                sh """
                cd ${SRV_DIR}
                docker compose build spring
                """
            }
        }

        stage('Deploy container') {
            steps {
                sh """
                cd ${SRV_DIR}
                docker compose up -d spring
                """
            }
        }
    }

    post {
        success {
            echo "ğŸš€ ë°°í¬ ì™„ë£Œ (ë˜ëŠ” ë³€ê²½ ì—†ìŒìœ¼ë¡œ ì •ìƒ ì¢…ë£Œ)"
        }
        failure {
            echo "âŒ ë°°í¬ ì‹¤íŒ¨. 'docker logs spring' ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸ í•„ìš”."
        }
    }
}
